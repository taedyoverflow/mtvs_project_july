<!DOCTYPE html>
<html lang="en"xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta class="test" name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">

    <title>Impact Bootstrap Template - Blog Details</title>
    <meta content="" name="description">
    <meta content="" name="keywords">

    <!-- Favicons -->
    <link href="/assets/img/favicon.png" rel="icon"/>
    <link href="/assets/img/apple-touch-icon.png" rel="apple-touch-icon"/>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,600;1,700&family=Montserrat:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&family=Raleway:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet"/>

    <!-- Vendor CSS Files -->
    <link href="/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="/assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet"/>
    <link href="/assets/vendor/aos/aos.css" rel="stylesheet"/>
    <link href="/assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet"/>
    <link href="/assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet"/>

    <!-- Template Main CSS File -->
    <link href="/assets/css/main.css" rel="stylesheet"/>

    <!-- =======================================================
    * Template Name: Impact
    * Updated: May 30 2023 with Bootstrap v5.3.0
    * Template URL: https://bootstrapmade.com/impact-bootstrap-business-website-template/
    * Author: BootstrapMade.com
    * License: https://bootstrapmade.com/license/
    ======================================================== -->
</head>

<body>

<section id="topbar" class="topbar d-flex align-items-center">
    <div class="container d-flex justify-content-center justify-content-md-between">
        <div class="contact-info d-flex align-items-center" th:if="${user != null}">
            <i class="bi bi-envelope d-flex align-items-center"><a href="/messages/received"><span>받은 쪽지함</span></a></i>
            <i class="bi bi-person d-flex align-items-center ms-4"><span th:text="${user.major}"></span><span th:text="${user.nickname}"></span><span>님 환영합니다.</span></i>
        </div>

        <div class="contact-info d-flex align-items-center" th:if="${user == null}">
            <i class="bi bi-person-add d-flex align-items-center"><a href="/auth/join"><span>회원가입 신청</span></a></i>
        </div>
    </div>
</section><!-- End Top Bar -->

<header id="header" class="header d-flex align-items-center">

    <div class="container-fluid container-xl d-flex align-items-center justify-content-between">
        <a href="/" class="logo d-flex align-items-center">
            <!-- Uncomment the line below if you also wish to use an image logo -->
            <!-- <img src="assets/img/logo.png" alt=""> -->
            <h1>MetaMate<span>.</span></h1>
        </a>
        <nav id="navbar" class="navbar">
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/board/list">Blog</a></li>
                <li><a href="/#team">Team</a></li>
                <li><a href="/#about">About</a></li>
                <li class="dropdown"><a href="#"><span>Easy Menu</span> <i class="bi bi-chevron-down dropdown-indicator"></i></a>
                    <ul>
                        <li><a href="/">Home</a></li>
                        <li class="dropdown"><a href="/board/list"><span>Blog</span> <i class="bi bi-chevron-down dropdown-indicator"></i></a>
                            <ul>
                                <li><a href="/board/list">All Blog list</a></li>
                            </ul>
                        </li>
                        <li><a href="/#team">Team</a></li>
                        <li><a href="/#about">About</a></li>
                    </ul>
                </li>
                <li th:if="${user != null}"><a href="/auth/edit">My Page</a></li>
            </ul>
        </nav><!-- .navbar -->

        <i class="mobile-nav-toggle mobile-nav-show bi bi-list"></i>
        <i class="mobile-nav-toggle mobile-nav-hide d-none bi bi-x"></i>

    </div>
</header><!-- End Header -->
<!-- End Header -->

<main id="main">

    <!-- ======= Breadcrumbs ======= -->
    <div class="breadcrumbs">
        <div class="page-header d-flex align-items-center" style="background-image: url('');">
            <div class="container position-relative">
                <div class="row d-flex justify-content-center">
                    <div class="col-lg-6 text-center">
                        <h2>자유게시판</h2>
                        <p>게시글 세부사항</p>
                    </div>
                </div>
            </div>
        </div>
        <nav>
            <div class="container">
                <ol>
                    <li><a href="/">Home</a></li>
                    <li><a href="/board/list">Blog</a></li>
                    <li>Blog Details</li>
                </ol>
            </div>

        </nav>
    </div><!-- End Breadcrumbs -->

    <!-- ======= Blog Details Section ======= -->
    <section id="blog" class="blog">
        <div class="container" data-aos="fade-up">

            <div class="row g-5">

                <div class="col-lg-8">

                    <article class="blog-details">

                        <!-- <div class="post-img">
                          <img src="assets/img/blog/blog-1.jpg" alt="" class="img-fluid">
                        </div> -->

                        <h2 class="title" th:text="${boardDetail.boardTitle}"></h2>

                        <div class="meta-top">
                            <ul>
                                <!--작성자, 작성 일시, 댓글 수 넣는 곳-->
                                <li class="d-flex align-items-center"><i class="bi bi-person" ><a href="#" onclick="openModal('${boardDetail.boardWriter}')">
                                    <span th:text="${boardDetail.boardWriter}"></span>
                                </a></i></li>
                                <li class="d-flex align-items-center" ><i class="bi bi-clock" th:text="${boardDetail.getCreatedAt()}"></i></li>
                                <li class="d-flex align-items-center"><i class="bi bi-hand-thumbs-up" th:text="${boardDetail.likeCount}"></i></li>
                                <li class="d-flex align-items-center"><i class="bi bi-at" th:text="${boardDetail.boardCategory}"></i></li>
                                <li class="d-flex align-items-center"><i class="bi bi-hand-index"  th:text="| 조회수 : ${boardDetail.boardHits}|"></i></li>
                            </ul>
                        </div><!-- End meta top -->

                        <div class="content">
                            <p th:text="${boardDetail.boardContent}"></p>
                        </div>

                    </article><!-- End blog post -->
                    <br>
                    <div style="text-align: center">
                        <button type="button" id="like" class="btn btn-outline-success" th:onclick="'pushLike(' + ${boardDetail.boardNo} + ', ' + ${boardDetail.likeNo} + ')'"
                                th:unless="${boardDetail.isLiked}"><i class="bi bi-hand-thumbs-up"></i></button>
                        <button type="button" id="delete" class="btn btn-outline-danger" th:onclick="'deleteLike(' + ${boardDetail.boardNo} + ', ' + ${boardDetail.likeNo} + ')'"
                                th:if="${boardDetail.isLiked}"><i class="bi bi-hand-thumbs-down"></i></button>
                    </div>
                    <br><br>
                    <h4 class="comments-count"><strong th:text="|댓글 수 (${boardDetail.commentList.size()})|" style="color: #008374"></strong></h4>
                    <div class="post-author d-flex align-items-center" th:each="comment : ${boardDetail.commentList}">
                        <!-- <img src="assets/img/blog/blog-author.jpg" class="rounded-circle flex-shrink-0" alt=""> -->
                        <div>
                            <h6 th:if="${!comment.isCommentIsDeleted()}" style="font-family: 'Bookman Old Style'" onclick="openModal('${comment.commentWriter}')">
                                <strong th:text="|${comment.getCommentWriter()}(님)|"></strong>
                            </h6>
                            <hr>
                            <span th:id="'comment-content-' + ${comment.commentNo}" th:text="|${comment.commentContent}|"></span>
                            <input type="text" class="edit-comment-input" th:id="'edit-comment-input-' + ${comment.commentNo}" th:value="${comment.commentContent}" style="display: none;"><hr>
                            <time th:if="${!comment.isCommentIsDeleted}" th:text="|${comment.getCreatedDate()}|"></time>
                            <button class="btn btn-outline-primary btn-sm" th:if="${user != null && user.nickname == comment.commentWriter}" th:id="'edit-button-' + ${comment.commentNo}" th:onclick="'editComment(\'' + ${comment.commentNo} + '\')'">수정</button>
                            <button class="btn btn-outline-danger btn-sm" th:if="${user != null && user.nickname == comment.commentWriter}" th:id="'update-button-' + ${comment.commentNo}" th:onclick="'updateComment(\'' + ${comment.commentNo} + '\')'" style="display: none;">확인</button>
                            <button class="btn btn-outline-danger btn-sm" th:if="${user != null && user.nickname == comment.commentWriter}" th:onclick="'deleteComment(\'' + ${comment.commentNo} + '\')'">삭제</button>
                        </div>
                    </div><!-- End post author -->

                    <div class="comments">
                        <!--댓글 작성 폼-->
                        <input type="hidden" name="refBoardNo" th:value="${boardDetail.boardNo}">
                        <div class="reply-form" id="commentList">
                            <h4>Comment</h4>
                            <p>당신의 답글을 작성해주세요</p>
                            <div class="row">
                            </div>
                            <div class="row">
                                <div class="col form-group">
                                    <textarea name="replyContents" class="form-control" placeholder="댓글을 작성해주세요" id="replyContents" required="required"></textarea>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary" th:onclick="'submitComment(\'' + ${boardDetail.boardNo} + '\')'" style="text-align: right">댓글 작성</button>
                        </div>

                    </div><!-- End blog comments -->
                    <br>
                    <br>
                    <div class="btn-group" role="group" aria-label="Basic outlined example" style="margin-left: 338px"  th:if="${user != null && user.nickname == boardDetail.boardWriter}">
                        <form th:action="@{'/board/edit/' + ${boardNo}}" method="get">
                            <input type="hidden" th:name="_csrf" th:value="${_csrf.token}" />
                            <button type="submit" class="btn btn-outline-success">수정</button>
                        </form>
                        <form th:action="@{'/board/detail/' + ${boardNo}}" method="post">
                            <input type="hidden" th:name="_csrf" th:value="${_csrf.token}" />
                            <button type="submit" class="btn btn-outline-danger">삭제</button>
                        </form>
                        <button onclick="location.href='/board/list'" class="btn btn-outline-dark" >목록</button>
                    </div>

                </div>
            </div>
        </div>

        </div>
    </section><!-- End Blog Details Section -->

</main><!-- End #main -->

<!-- ======= Footer ======= -->
<footer id="footer" class="footer">

    <div class="container">
        <div class="row gy-4">
            <div class="col-lg-5 col-md-12 footer-info">
                <a href="index.html" class="logo d-flex align-items-center">
                    <span>MetaMate</span>
                </a>
                <p>MetaMate 는 메타버스 아카데미 교육생들의 커뮤니케이션 및 프로젝트 인원 모집, 간단한 메타버스 아카데미의 정보를 담은 사이트 입니다. 이 사이트로 여러분들의 소통이 더욱 원활해졌으면 좋겠습니다. TEAM _ Go-On-That</p>
                <div class="social-links d-flex mt-4">
                    <a href="#" class="twitter"><i class="bi bi-twitter"></i></a>
                    <a href="#" class="facebook"><i class="bi bi-facebook"></i></a>
                    <a href="#" class="instagram"><i class="bi bi-instagram"></i></a>
                    <a href="#" class="linkedin"><i class="bi bi-linkedin"></i></a>
                </div>
            </div>

            <div class="col-lg-2 col-6 footer-links">
                <h4>Useful Links</h4>
                <ul>
                    <li><a href="/">Home</a></li>
                    <li><a href="/#about">About us</a></li>
                    <li><a href="/#team">Team</a></li>
                    <li><a href="/board/list">Board</a></li>
                </ul>
            </div>

            <div class="col-lg-2 col-6 footer-links">
                <h4>Our Services</h4>
                <ul>
                    <li>서버개발</li>
                    <li>3D모델링</li>
                    <li>콘텐츠기획</li>
                    <li>Unity</li>
                    <li>Unreal</li>
                    <li>XR</li>
                    <li>자율전공</li>
                    <li>AI</li>
                </ul>
            </div>

            <div class="col-lg-3 col-md-12 footer-contact text-center text-md-start">
                <h4>Contact Us</h4>
                <p>
                    C-106 강의장 <br>
                    메타버스 아카데미<br>
                    TEAM : GO-ON-THAT<br><br>
                    <strong>Phone:</strong> +82 010-5518-2290<br>
                    <strong>Email:</strong> pyunghun120@gmail.com<br>
                </p>

            </div>

        </div>
    </div>

    <div class="container mt-4">
        <div class="copyright">
            &copy; Copyright <strong><span>MetaMate</span></strong>. All Rights Reserved
        </div>
        <div class="credits">
            <!-- All the links in the footer should remain intact. -->
            <!-- You can delete the links only if you purchased the pro version. -->
            <!-- Licensing information: https://bootstrapmade.com/license/ -->
            <!-- Purchase the pro version with working PHP/AJAX contact form: https://bootstrapmade.com/impact-bootstrap-business-website-template/ -->
            Designed by <a href="https://bootstrapmade.com/">BootstrapMade</a>
        </div>
    </div>

</footer><!-- End Footer -->
<!-- End Footer -->

<a href="#" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

<div id="preloader"></div>
<div class="modal" tabindex="-1" id="sendMessageModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">쪽지 보내기</h5>
                <button type="button" class="btn-close" onclick="closeModal()"></button>
            </div>
            <div class="modal-body">
                <p th:text="|(${boardDetail.boardWriter})님께 쪽지를 보내시겠습니까?|"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closeModal()">닫기</button>
                <button id="sendMessageButton" type="button" class="btn btn-primary" onClick="redirectToDynamicLink()">확인</button>
            </div>
        </div>
    </div>
</div>
<div class="modal" tabindex="-1" id="sendMessageModal1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">쪽지 보내기</h5>
                <button type="button" class="btn-close" onclick="closeModal()"></button>
            </div>
            <div class="modal-body">
                <p id="modalContent"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closeModal()">닫기</button>
                <button id="sendMessageButton1" type="button" class="btn btn-primary" onClick="redirectToDynamicLink()">확인</button>
            </div>
        </div>
    </div>
</div>
<script>
    function openModal(commentWriter) {
        // Get the modal element
        var modal = document.getElementById("sendMessageModal1");

        // Set the content of the modal
        var modalContent = modal.querySelector(".modal-body p");
        modalContent.innerText = `${commentWriter}님께 쪽지를 보내시겠습니까?`;

        // Show the modal
        modal.style.display = "block";
    }

    function closeModal() {
        // Close the modal
        var modal = document.getElementById("sendMessageModal1");
        modal.style.display = "none";
    }
</script>
<script th:inline="javascript">
    var dynamicLink = /*[[ @{/messages/sendForm(receiverNickname=${boardDetail.boardWriter})} ]]*/ '';
</script>
<script>
    function redirectToDynamicLink() {
        // 동적으로 생성된 주소로 리다이렉트
        window.location.href = dynamicLink;
    }
</script>
<script>
    function openModal(boardWriter) {
        // 모달창 열기
        var modal = document.getElementById("sendMessageModal");
        modal.style.display = "block";
    }

    function closeModal() {
        var modal = document.getElementById("sendMessageModal");
        modal.style.display = "none";
    }
</script>
<script>
    function submitComment(boardNo) {
        const replyContents = $("#replyContents").val();
        const csrfToken = $("meta[name='_csrf']").attr("content");

        $.ajaxPrefilter(function (options, originalOptions, jqXHR) {
            if (options['type'].toLowerCase() === "post") {
                jqXHR.setRequestHeader('X-CSRF-TOKEN', csrfToken);
            }
        });

        $.ajax({
            url: `/comment/${boardNo}`,
            data: {
                refBoardNo: boardNo,
                commentContent: replyContents
            },
            type: "POST",
            success: function (data, status, xhr) {
                // 등록 성공시 처리
                console.log(data);
                alert("댓글 등록이 완료되었습니다.");
                location.reload();
                // 댓글 목록을 다시 로딩하는 등의 작업 수행
            },
            error: function (data) {
                // 등록 실패시 처리
                console.log(data);
                alert("권한이 없습니다.");
            }
        });
    }


    function deleteComment(commentNo) {
        var csrfToken = $("meta[name='_csrf']").attr("content");
        var url = "/comment/" + commentNo;

        console.log(commentNo);
        $.ajax({
            url: url,
            type: "DELETE",
            beforeSend: function(xhr) {
                xhr.setRequestHeader('X-CSRF-TOKEN', csrfToken);
            },
            success: function(data, status, xhr) {
                // 수정 성공 시 처리
                console.log(data);
                alert("댓글 삭제가 완료되었습니다.");
                location.reload();
                // 댓글 목록을 다시 로딩하는 등의 작업 수행
            },
            error: function(data) {
                // 삭제 실패 시 처리
                console.log(data);
                alert("권한이 없습니다.");
            }
        });
    }

    function updateComment(commentNo) {
        var csrfToken = $("meta[name='_csrf']").attr("content");
        var url = "/edit/" + commentNo;
        var updatedCommentContent = $("#edit-comment-input-" + commentNo).val();

        $.ajax({
            url: url,
            type: "PUT",
            beforeSend: function (xhr) {
                xhr.setRequestHeader('X-CSRF-TOKEN', csrfToken);
            },
            data: { commentContent: updatedCommentContent },
            success: function (data, status, xhr) {
                console.log(data);
                alert("댓글 수정이 완료되었습니다.");
                location.reload();
            },
            error: function (xhr, status, error) {
                console.log(xhr);
                alert("권한이 없습니다.");
            }
        });
    }

    function editComment(commentNo) {
        var commentContentSpan = $("#comment-content-" + commentNo);
        var commentContentInput = $("#edit-comment-input-" + commentNo);
        var updateButton = $("#update-button-" + commentNo);
        var editButton = $("#edit-button-" + commentNo);

        commentContentSpan.hide();
        commentContentInput.show();
        updateButton.show();
        editButton.hide();


    }
    function pushLike(boardNo, likeNo) {
        var csrfToken = $("meta[name='_csrf']").attr("content");
        var url = "/like/" + boardNo;

        $.ajaxPrefilter(function(options, originalOptions, jqXHR) {
            if (options['type'].toLowerCase() === "post") {
                jqXHR.setRequestHeader('X-CSRF-TOKEN', csrfToken);
            }
        });

        $.ajax({
            url: url,
            data: {
                boardNo: boardNo,
                likeNo: likeNo
            },
            type: "POST",
            success: function(data, status, xhr) {
                // 등록 성공시 처리
                console.log(data);
                alert("좋아요가 완료되었습니다.");
                location.reload();

                $("#like").hide();
                $("#delete").show();

                // 숨겨둔 좋아요 취소 버튼을 활성화
                $("#likeStatusUp-" + likeNo).show();

                // 좋아요 버튼을 비활성화
                $("#like").prop("disabled", true);

                // 좋아요 카운트를 업데이트
                var likeCount = data.length;
                $("#likeStatus-" + likeNo).text(likeCount);
            },
            error: function(data) {
                // 등록 실패시 처리
                console.log(data);
                alert("좋아요 등록 실패");
            }
        });
    }

    function deleteLike(boardNo, likeNo) {
        var csrfToken = $("meta[name='_csrf']").attr("content");
        var url = "/like/" + boardNo;

        $.ajaxPrefilter(function(options, originalOptions, jqXHR) {
            if (options['type'].toLowerCase() === "post") {
                jqXHR.setRequestHeader('X-CSRF-TOKEN', csrfToken);
            }
        });

        $.ajax({
            url: url,
            data: {
                boardNo: boardNo,
                likeNo: likeNo
            },
            type: "POST",
            success: function(data, status, xhr) {
                // 등록 성공시 처리
                console.log(data);
                alert("좋아요 취소가 완료되었습니다.");
                location.reload();

                // 좋아요 취소 버튼을 숨기고, 좋아요 버튼을 보이도록 설정
                $("#delete").hide();
                $("#like").show();

                // 숨겨둔 좋아요 취소 버튼을 숨김
                $("#likeStatusUp-" + likeNo).hide();

                // 좋아요 버튼을 활성화
                $("#like").prop("disabled", false);
            },
            error: function(data) {
                // 등록 실패시 처리
                console.log(data);
                alert("좋아요 취소 실패");
            }
        });
    }
</script>
<!-- Vendor JS Files -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/assets/vendor/aos/aos.js"></script>
<script src="/assets/vendor/glightbox/js/glightbox.min.js"></script>
<script src="/assets/vendor/purecounter/purecounter_vanilla.js"></script>
<script src="/assets/vendor/swiper/swiper-bundle.min.js"></script>
<script src="/assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
<script src="/assets/vendor/php-email-form/validate.js"></script>

<!-- Template Main JS File -->
<script src="/assets/js/main.js"></script>

</body>

</html>